import { r, m } from './contentService-88d7aab1.js';
import { W, P, j, R, H, x as x$1, k, i } from './tools-bb3e9d9c.js';
import { t } from './storage-e4d9282e.js';
import { w as we } from './reactivity.esm-bundler-3cf16f7a.js';

const g={tab:null,data:[],tabName:null},h={product:["unkown","GP","WEB-PLUG","WIN-GS","MAC-GS","WIN-GR","MAC-GR"],browser:["unkown","chrome","safari","ie","opera","firefox","edge","other"],system:["unkown","windows","mac","linux","android","ios","other"],languages:["en","jp","de","fr","es","ar","it","pt"],timezone:["UTC/GMT -10","UTC/GMT -9","UTC/GMT -8","UTC/GMT -7","UTC/GMT -6","UTC/GMT -5","UTC/GMT -4","UTC/GMT -3","UTC/GMT -2","UTC/GMT -1","UTC/GMT +0","UTC/GMT +1","UTC/GMT +2","UTC/GMT +3","UTC/GMT +4","UTC/GMT +5","UTC/GMT +6","UTC/GMT +7","UTC/GMT +8","UTC/GMT +9","UTC/GMT +10","UTC/GMT +11","UTC/GMT +12","UTC/GMT +13","UTC/GMT +14"]},u={agent:navigator.userAgent.toLowerCase(),device:[[e=>/windows/.test(e),"windows"],[e=>/iphone|ipod/.test(e)&&/mobile/.test(e),"ios"],[e=>/android/.test(e)&&/mobile/.test(e),"android"],[e=>/linux/.test(e),"linux"],[e=>/mac/.test(e),"mac"],[()=>!0,"other"]],browser:[[e=>/ie/.test(e),"ie"],[e=>/opr/.test(e),"opera"],[e=>/edg/.test(e),"edge"],[e=>/chrome/.test(e),"chrome"],[e=>/safari/.test(e),"safari"],[e=>/firefox/.test(e),"firefox"],[()=>!0,"other"]]};chrome.storage.local.set({snap_version:"2.0.1.1"});const b=we();let p=()=>null;const T=(e,t,a)=>{chrome.tabs.captureVisibleTab({format:"png"},(o=>{if(!o)return chrome.storage.local.set({disableHomePage:!1}),chrome.storage.local.set({isScrollerScreen:!1}),chrome.storage.local.set({completeProgress:0}),chrome.action.setBadgeBackgroundColor({color:""}),void chrome.action.setBadgeText({tabId:g.tab.id,text:""});const s={...t.data,extData:o},r={type:t.type,tab:e.id,data:s};a?.(r);}));};chrome.contextMenus.create({title:"Gemoo Snap - Screen Capture",id:"snap",type:"normal",contexts:["all"]});function f(e,t){"open"===e?setTimeout((()=>{chrome.tabs.sendMessage(t,{option_message:"open_install_guide"});}),2e3):chrome.tabs.sendMessage(t,{option_message:"close_install_guide"});}[{title:chrome.i18n.getMessage("menuTool1"),id:"Scrolling Capture"},{title:chrome.i18n.getMessage("menuTool2"),id:"Selected Area"},{title:chrome.i18n.getMessage("menuTool3"),id:"Elenment Screenshot"},{title:chrome.i18n.getMessage("menuTool4"),id:"Visible Area"},{title:chrome.i18n.getMessage("menuTool5"),id:"Browser Capture"}].forEach((e=>{chrome.contextMenus.create({...e,parentId:"snap",type:"normal",contexts:["all"]});})),chrome.contextMenus.onClicked.addListener((function(e,t){let a=!0;chrome.storage.onChanged.addListener((e=>{e.disableHomePage&&!e.disableHomePage.newValue&&(a=!1);})),setTimeout((()=>{a&&(chrome.storage.local.set({disableHomePage:!0}),"Scrolling Capture"==e.menuItemId?(chrome.storage.local.set({isScrollerScreen:!0}),chrome.tabs.sendMessage(t?.id,{rightMenu:"menu",type:1})):"Selected Area"==e.menuItemId?(chrome.storage.local.set({isRegionScreen:!0}),chrome.tabs.sendMessage(t?.id,{rightMenu:"menu",type:2})):"Elenment Screenshot"==e.menuItemId?(chrome.storage.local.set({isRegionScreen:!0}),chrome.tabs.sendMessage(t?.id,{rightMenu:"menu",type:3})):"Visible Area"==e.menuItemId?chrome.tabs.sendMessage(t?.id,{rightMenu:"menu",type:4}):"Browser Capture"==e.menuItemId&&chrome.tabs.sendMessage(t?.id,{rightMenu:"menu",type:5}));}),200);})),chrome.runtime.onMessage.addListener(((t$1,i,m)=>{const h=t$1;switch(h.type){case"ext_ga_evt":chrome.tabs.sendMessage(t$1.tabId,t$1);break;case"capture":!function(t$1,a){y((o=>{b.value=o,g.tab=null;const s=t$1.data;switch(s.id){case"capture_visible_part":return void T(o,t$1,(e=>{"capture_visible"!=t$1.data.name&&I(e.data.extData),a(e);}));case"capture_window":case"capture_tab":case"capture_screen":return void((e,t,a)=>{chrome.desktopCapture.chooseDesktopMedia(["window","tab","screen"],e,(a=>{a?setTimeout((()=>{const o={...t.data,extData:a},s={type:t.type,tab:e.id,data:o};C(s,(()=>{}));}),200):chrome.storage.local.set({disableHomePage:!1});})),a(e);})(o,t$1,a);case"show_main":M(),y((t$1=>{t("isScrollerScreen").then((a=>{a?r({type:"stop_capture",data:{}}):(t("tabId").then((e=>{e&&e!=t$1.id&&chrome.tabs.sendMessage(e,{openHomePage:!1});})),t$1.id&&(chrome.tabs.sendMessage(t$1.id,{openHomePage:!0}),chrome.storage.local.set({tabId:t$1.id})));}));}));break;default:C({type:"capture",tab:o.id,data:s},(()=>a("call content to capture!")));}}));}(h,m);break;case"visible":I(h);break;case"save":switch(h.data.id){case"capture_snippet":case"capture_scroll_part":case"capture_select_area":w(h.data.extData,h.data.name);}break;case"scroll_capture":!function(e,t$1){y((a=>{T(a,e,t$1);}));const a=e.data;var o="";o=`${Math.round(100*a.extData.complete)}`,t("isRegionScreen").then((e=>{if(!e){parseInt(o)>0&&(chrome.action.setBadgeBackgroundColor({color:"#FFD099"}),chrome.action.setBadgeText({tabId:g.tab.id,text:o+"%"}));}}));}(h,m);break;case"edit":I(h.data);break;case"get_data":const a=g.data;a&&!Array.isArray(a)&&chrome.storage.local.set({img_cache:a}),m(g.data);break;case"base64":b.value="",I(h.data||h.url);}if("close_install_guide"===t$1.option_message&&chrome.tabs.query({},(e=>{e.forEach((e=>f("close",e.id)));})),1==t$1.openAboutUs)chrome.tabs.create({url:"./aboutUs/index.html"});else if("changeTab"===t$1.request)chrome.storage.local.set({disableHomePage:!1}),chrome.storage.local.set({isScrollerScreen:!1}),chrome.action.setBadgeBackgroundColor({color:""}),chrome.action.setBadgeText({tabId:g.tab.id,text:""});else if(1==t$1.imgThumbnail){if(!t$1.coverData)return;t("cardId").then((e=>{let r,c,n;const i=function(e){let t,a=" | Gemoo Snap";if(e.title)t=e.title;else if(e.url)t=e.url;else {let e=new Date;t=`${e.getFullYear()}-${e.getMonth()+1<10?"0"+(e.getMonth()+1):e.getMonth()+1}-${e.getDate()<10?"0"+e.getDate():e.getDate()} ${e.getHours()<10?"0"+e.getHours():e.getHours()}:${e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes()}:${e.getSeconds()<10?"0"+e.getSeconds():e.getSeconds()}`;}if(t.length+a.length>64){let e=t.length+a.length-64;t=t.substring(0,t.length-e);}return t+a}(b.value),m=t$1.coverData,g=t$1.thumbnailData;W({card:e,name:i,base64:m,thumbnail:g,signal:P.signal,uploadStart:()=>{y((e=>{n=e.id,chrome.tabs.sendMessage(e.id,{loadingShow:!0,tabId:e.id});}));},uploadEnd:e=>{chrome.storage.local.set({disableHomePage:!1}),t(["access_token","refresh_token","cardId","openWindowPath"]).then((t=>{chrome.tabs.sendMessage(n,{loadingShow:!1,tabId:n}),t.cardId&&j({card_id:t.cardId}).then((e=>{if(0==e.code)if(e.result){let t=e.result.split("/");t=`{${t.join(" > ")}}`,chrome.storage.local.set({cardPath:t});}else chrome.storage.local.remove("cardId"),chrome.storage.local.remove("createPathShow");})),t.access_token&&t.refresh_token&&(chrome.tabs.sendMessage(n,{toMsgBoxSuc:"succ",res:e}),chrome.tabs.sendMessage(c,{type:"uploadover"}),chrome.storage.local.set({disableHomePage:!1}));}));},uploadError:(e,a)=>{chrome.storage.local.set({disableHomePage:!1}),chrome.tabs.sendMessage(n,{loadingShow:!1,tabId:n});const o={login:()=>{chrome.tabs.sendMessage(n,{openHomePage:!0});},size:()=>{chrome.tabs.sendMessage(n,{isPurchase:!0,res:a});},number:()=>{chrome.tabs.sendMessage(n,{isPurchase:!0,res:a,isCount:!0});}};"string"==typeof e&&o[e]&&o[e](),p(),S(m,t$1.rect);},uploadProgress:(e,t$1)=>{r=e,"createEmptyPageEnd"===e?t(["access_token","refresh_token","cardId","openWindowPath","screenType"]).then((e=>{chrome.tabs.create({url:R+`/image/detail/${t$1.page}?token=${e.access_token}&refreshtoken=${e.refresh_token}&action=empty&feature=${e.screenType}`},(e=>{c=e.id;}));})):"createMultipartEnd"===r&&(p=t$1);}});}));}else !0===t$1.openLocalPage&&S(t$1.coverData,t$1.rect);switch(t$1.request){case"login":k(t$1.data).then((e=>{if(0===e.code){let t=e.result.access_token,a=e.result.refresh_token;chrome.storage.local.set({access_token:t}),chrome.storage.local.set({refresh_token:a}),m({logincb:"success",result:e});}else m({logincb:"fail",msg:e.message,result:e});})).catch((()=>{m({logincb:"fail"});}));break;case"userProfile":x$1().then((e=>{0===e.code?m({userProfilecb:"success",msg:e.result}):m({userProfilecb:"fail",msg:e.code});})).catch((()=>{m({userProfilecb:"fail"});}));break;case"userSpaceSize":H().then((e=>{0===e.code?m({userSpaceSizecb:"success",msg:e.result}):m({userSpaceSizecb:"fail"});})).catch((()=>{m({userSpaceSizecb:"fail"});}));break;case"bindCard":t("cardId").then((e=>{e?j({card_id:e}).then((e=>{0===e.code?m({bindCardcb:"success",msg:e.result}):m({bindCardcb:"fail",mas:e});})).catch((e=>{m({bindCardcb:"fail",mas:e});})):m({bindCardcb:"fail"});}));break;case"jumpGemoo":chrome.tabs.query({active:!0,currentWindow:!0},(e=>{setTimeout((()=>{if(e&&e.length)for(let t=0;t<e.length;t++)-1!=e[t].url.search("https://gemoo.com/")&&chrome.tabs.sendMessage(e[t].id,{openHomePage:!0});}),2e3);}));break;case"StopScreen":setTimeout((()=>{chrome.action.setBadgeBackgroundColor({color:""}),chrome.action.setBadgeText({tabId:g.tab.id,text:""});}),1e3),r({type:"stop_capture",data:{}});}return 1==t$1.chromeLogin&&t("tabId").then((e=>{chrome.tabs.sendMessage(e,{chromeLogin:!0});})),1==t$1.cancelUploadImage&&(P.abort(),p()),!0})),chrome.runtime.onInstalled.addListener((e=>{chrome.tabs.query({},(e=>{for(let t=0;t<e.length;t++)chrome.scripting.executeScript({target:{tabId:e[t].id},files:["lib/html2canvas.min.js","content-scripts/import-main.js","lib/gtag.js"]}).then((a=>{f("close",e[t].id),f("open",e[t].id);}));}));}));const M=async()=>{const e=await x();y((t=>{chrome.tabs.sendMessage(t.id,{options:e,isContry:!0});}));},w=(e,t)=>{chrome.downloads.download({filename:i(t),url:e},(e=>{}));},C=(e,a)=>{m(e,a);},y=e=>{g.tab?e?.(g.tab):chrome.tabs.query({active:!0,currentWindow:!0},(t=>{t&&t.length&&(g.tab=t[0],e?.(t[0]));}));},S=(e,t)=>{y((a=>{let o=null;"string"==typeof e?o={tabName:"window",currentTabInfo:{index:a.index+1,id:a.id},extData:e}:(e.tabName=b.value.title,e.currentTabInfo={index:a.index+1,id:a.id},o=e),o.rect=t,chrome.tabs.create({url:"/edit/edit.html",index:a.index+1,windowId:a.windowId},(()=>g.data=o));}));},_=(e,t,a,o,s)=>{y((r=>{chrome.tabs.sendMessage(r.id,{type:"capture",data:{id:"edit_view",option:{left:e.x,top:e.y,width:e.w,height:e.h,image:t,name:r.title,path:a,captureType:o,autoTrigger:s}}},(()=>{}));}));},I=e=>{chrome.storage.local.set({disableHomePage:!1}),t(["screenType","openWindowPath","isHaveScroll","rect","access_token","autoTrigger","isScrollCopy"]).then((t=>{const a=t.autoTrigger;chrome.storage.local.remove("autoTrigger"),t.isScrollCopy?(chrome.storage.local.set({isScrollCopy:!1}),y((a=>{chrome.tabs.sendMessage(a.id,{isCopy:!0,data:e,rect:t.rect});}))):"scrolling"==t.screenType||"browser"===t.screenType?"local"===t.openWindowPath?"browser"===t.screenType?S(e,null):S(e,t.rect):y((t=>{chrome.tabs.sendMessage(t.id,{imgThumbnail:!0,data:e});})):"selected"==t.screenType||"element"===t.screenType?t.isHaveScroll?"local"===t.openWindowPath?S(e,t.rect):y((t=>{chrome.tabs.sendMessage(t.id,{imgThumbnail:!0,data:e});})):_(t.rect,e,t.openWindowPath,t.screenType,a||""):"visible"==t.screenType&&_(t.rect,e,t.openWindowPath,t.screenType,a||"");})),chrome.storage.local.remove("rect"),chrome.action.setBadgeBackgroundColor({color:""}),chrome.action.setBadgeText({tabId:g.tab?.id,text:""}),chrome.storage.local.set({isRegionScreen:!1}),chrome.storage.local.set({isScrollerScreen:!1}),chrome.storage.local.set({completeProgress:0}),chrome.storage.local.set({disableHomePage:!1});};const x=async()=>{const e=Math.floor((new Date).getTimezoneOffset()/-60),t=navigator.language,a=u.device.find((e=>e[0](u.agent)))[1],o=h.timezone.findIndex((t=>"UTC/GMT "+(e>0?`+${e}`:e)===t)),s=h.system.findIndex((e=>e===a)),r=h.browser.findIndex((e=>u.browser.find((e=>e[0](u.agent)))[1]===e)),c=h.languages.findIndex((e=>t.toLowerCase().includes(e)));let n;const[i,l]=await fetch("https://checkout.paddle.com/api/2.0/prices?product_ids=635995").then((e=>[null,e])).catch((e=>[e,null]));if(!i&&l.ok){const{response:e}=await l.json();n=["TW","MO","HK"].includes(e.customer_country)?"CN":e.customer_country;}return new Promise((e=>{e((e=>{const t={};for(const a in e)"number"==typeof e[a]?(t[a]=e[a]<0?0:e[a],"product"===a&&(t[a]=t[a]<1?1:t[a])):t[a]=e[a];return t})({product:2,browser:r,system:s,language:c,timezone:o,area:n,channel:"Gemoo"}));}))};
