async function messageHandler(t,e){"enableOnTab"==t.type?chrome.permissions.request({origins:[t.currentOrigin]},function(e){e&&chrome.tabs.reload(t.currentTab.id)}):"disableOnTab"==t.type?(await chrome.permissions.remove({origins:[t.currentOrigin]}),await chrome.action.setIcon({path:"cheerpjAR_128x128_gray.png",tabId:t.currentTab.id}),await chrome.action.setTitle({title:"CheerpJ Applet Runner Disabled"})):"openLicensePage"==t.type?openLicensePage():"checkLicense"==t.type&&(t.key?handleKeyCheck(t.key,e):handleTokenCheck(t.token,e))}async function setIcon(e,t,a){"complete"===t.status&&a.url&&(a.url.startsWith("http://")||a.url.startsWith("https://"))&&(t=new URL(a.url).origin+"/*",await chrome.permissions.contains({origins:[t]})&&(chrome.action.setIcon({path:"cheerpjAR_32x32.png",tabId:e}),chrome.action.setTitle({title:"CheerpJ Applet Runner Enabled"})))}async function onInstall(e){"install"==e.reason&&await chrome.tabs.create({url:chrome.runtime.getURL("welcome.html")}),await chrome.scripting.unregisterContentScripts();await chrome.scripting.registerContentScripts([{id:"spoofScript",js:["spoof.js"],matches:["<all_urls>"],runAt:"document_start",world:"MAIN"},{id:"injectScript",js:["inject.js"],matches:["<all_urls>"]}]);e=await chrome.storage.managed.get("userAgent"),e=e.userAgent;if(e){e=createRules(e.uaString,e.platform);const a=await chrome.declarativeNetRequest.getDynamicRules();var t=a.map(e=>e.id);await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:t,addRules:e})}}async function reopenTab(e,t,a){"loading"==t.status&&a.url&&(a.url.startsWith("http://")||a.url.startsWith("https://"))&&(t=new URL(a.url).origin+"/*",await chrome.permissions.contains({origins:[t]})||(await chrome.tabs.create({url:a.url,index:a.index}),await chrome.tabs.remove(e)))}function createRules(e,t){return[{id:1,priority:1,action:{type:"modifyHeaders",requestHeaders:[{header:"user-agent",operation:"set",value:e}]},condition:{resourceTypes:["main_frame","sub_frame"]}},{id:2,priority:1,action:{type:"modifyHeaders",requestHeaders:[{header:"user-agent",operation:"set",value:e}]},condition:{}},{id:3,priority:1,action:{type:"modifyHeaders",requestHeaders:[{header:"sec-ch-ua-platform",operation:"set",value:`"${t}"`}]},condition:{resourceTypes:["main_frame","sub_frame"]}},{id:4,priority:1,action:{type:"modifyHeaders",requestHeaders:[{header:"sec-ch-ua-platform",operation:"set",value:`"${t}"`}]},condition:{}}]}chrome.tabs.onUpdated.addListener(reopenTab),chrome.runtime.onMessage.addListener((e,t,a)=>(messageHandler(e,a),!0)),chrome.tabs.onUpdated.addListener(setIcon),chrome.runtime.setUninstallURL("https://labs.leaningtech.com/feedback-appletrunner"),chrome.runtime.onInstalled.addListener(onInstall);var publicKeyData={alg:"RS256",e:"AQAB",ext:!0,key_ops:["verify"],kty:"RSA",n:"mzFDvDzjt-2k_OY4rGsknFp2aTGPhHYs2zOj7mkW-kVVWSyndHc6L62oiqyt8rT8-JfXu0cugSGpmuBlyG8fCpFyyop3TVCCMtZMJfCxuX7xV94QDrTxdR4ZosWiVsiEQKy8pyWeA3XCmtehPoQUZz3-DueUpZ7yrb5tLm1lk6SBeyRXzknUx3LRXnFmyvDnvRtP98EagDPeoQClZ1cyzZdn66pN0-SLtTc3KUeGF6-nI8QO7FdyGEZhO-OMjOWwJFQeqri75PT_g1AIj-An0TX29KuZ1m1-3padw9r7PfA7batl3yiTBTjB_Zb5L0f3we4fbqgGuYWViVlYgKTUqw"};async function initialLicenseCheck(){var e,t=(await chrome.storage.local.get("licenseData")).licenseData;(await chrome.storage.local.get("licensed")).licensed&&t.exp<Date.now()&&(t=(await chrome.storage.local.get("licenseKey")).licenseKey,e=(await chrome.storage.local.get("licenseToken")).licenseToken,(await validateLicenseToken(e=t?await retrieveTokenFromKey(t):e)).exp<Date.now()&&(openLicensePage(),await chrome.storage.local.remove("licensed")))}async function getInstallId(){var e=await chrome.storage.local.get("installId");if(e.installId)return e.installId;for(var t=new Uint8Array(8),a=(crypto.getRandomValues(t),""),n=0;n<8;n++){var r=t[n];r<16&&(a+="0"),a+=r.toString(16)}return await chrome.storage.local.set({installId:a}),a}async function validateLicenseToken(e){for(var e=e.split("."),t=await crypto.subtle.importKey("jwk",publicKeyData,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]),a=atob(e[2]),n=new Uint8Array(a.length),r=0;r<a.length;r++)n[r]=a.charCodeAt(r);var s=new TextEncoder("utf-8");if(!await crypto.subtle.verify("RSASSA-PKCS1-v1_5",t,n,s.encode(e[0]+"."+e[1])))return null;t=JSON.parse(atob(e[0]));return"RS256"!=t.alg||"JWT"!=t.typ?null:JSON.parse(atob(e[1]))}async function handleKeyCheck(e,t){try{t({success:!0,data:await validateLicenseToken(await retrieveTokenFromKey(e))})}catch(e){t({success:!1,data:{status:"error",message:e.message}})}}async function handleTokenCheck(e,t){try{e||(a=await chrome.storage.managed.get("licenseToken"),n=await chrome.storage.local.get("licenseToken"),e=a.licenseToken||n.licenseToken);var a,n,r=await validateLicenseToken(e);"applet-runner"==r.type&&t({success:!0,data:r}),t({success:!1,data:{status:"error",message:"Invalid license token"}})}catch(e){t({success:!1,data:{status:"error",message:e.message}})}}async function openLicensePage(){await chrome.tabs.create({url:chrome.runtime.getURL("license.html"),active:!0})}async function retrieveTokenFromKey(e){var t=await getInstallId();const a=await fetch(`https://jnlp-runner.leaning-technologies.workers.dev/verify?licenseKey=${e}&installId=${t}&extension=ar`);return await a.text()}